[gcode_macro START_PRINT]
#default_parameter_T_BED: 60
#default_parameter_T_EXTRUDER: 205
gcode:
    M117 Set temperatures
    M140 S{T_BED}
    M104 S{T_EXTRUDER}

    M117 Homing
    G90 ; use absolute coordinates
    G28 ; home printer
    LOAD_MESH_TEMP BED_TEMPERATURE={T_BED} ; use temperature mesh
    G1 X15 Y20 Z5 F6000 ; get nozzle close to bed
    
    M117 Waiting for temperatures
    M109 S{T_EXTRUDER}
    M190 S{T_BED}
    
    PRIME_LINE
    M117 Printing...
 
[gcode_macro PRIME_LINE]
gcode: 
    M117 Prime Line
    G92 E0 ; Reset Extruder
    G1 Z2.0 F3000 ; Move Z Axis up
    G1 X0 Y10 Z0.28 F5000.0 ; Move to start position
    G1 X0 Y140.0 Z0.28 F1500.0 E15 ; Draw the first line
    G1 X2 Y10.0 Z0.28 F5000.0 ; Move to side a little
    G1 X2 Y140 Z0.28 F1500.0 E30 ; Draw the second line
    G92 E0 ; Reset Extruder
    G1 Z2.0 F3000 ; Move Z Axis up

[gcode_macro END_PRINT]
gcode:
    G90 ; use absolute coordinates
    M104 S0 ; turn off temperature
    M140 S0 ; turn off temperature
    G28 X0 ; home X axis
    G1 Y150 F1500 ; move bed forward
    M84 ; disable motors
    M117 Done!

[gcode_macro LOAD_MESH_TEMP]
#default_parameter_BED_TEMPERATURE: 0
#default_parameter_FORCE: 0
gcode:
    {action_respond_info("- AUTOMATED BED MESH GENERATOR -")}
    {% if BED_TEMPERATURE|int < 30 %}
        {action_respond_info("Your bed temp is to low, make sure it is at least 30 or higher")}
    {% else %}
        {% if printer.configfile.config["bed_mesh " + BED_TEMPERATURE] is defined and FORCE|int == 0 %}
            BED_MESH_PROFILE LOAD={BED_TEMPERATURE}
            {action_respond_info("Succesfully loaded bed_mesh "+ BED_TEMPERATURE)}
        {% else %}
            {% if printer.configfile.config["bed_mesh " + BED_TEMPERATURE] is defined and FORCE|int == 1 %}
                BED_MESH_PROFILE REMOVE={BED_TEMPERATURE}
            {% endif %}
            {action_respond_info("bed_mesh not defined, your bed temperature will go up!")}
            {action_respond_info("We will probe the bed and save the mesh as bed_mesh "+ BED_TEMPERATURE)}
            ADD_BED_MESH TARGET_TEMP={BED_TEMPERATURE}
        {% endif %}
    {% endif %}

[gcode_macro ADD_BED_MESH]
#default_parameter_TARGET_TEMP: 30
gcode:
    M190 S{TARGET_TEMP} # Wait for the bed to hit TARGET_TEMP
    BED_MESH_CALIBRATE
    BED_MESH_PROFILE SAVE={TARGET_TEMP}

[gcode_macro SET_RETRACTIONLENGTH]
gcode:
  SET_RETRACTION RETRACT_LENGTH={params.LENGTH|float}
  GET_RETRACTION
